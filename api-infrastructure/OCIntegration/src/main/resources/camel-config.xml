<?xml version="1.0" encoding="UTF-8"?>

<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:camel="http://camel.apache.org/schema/spring"
	xsi:schemaLocation="
         http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
         http://camel.apache.org/schema/spring http://camel.apache.org/schema/spring/camel-spring.xsd">

	<!-- Pattern Processors -->
	<bean id="messageTranslator" class="com.csc.eip.pattern.MessageTranslator" />
	
	<!-- Custom Aggregation Strategy -->
	<bean id="aggregationStrategy" class="com.csc.eip.strategy.CollectionAggregationStrategy">
		<property name="mergeItemsString" value="${MERGE_ITEMS_INTO_ARRAY}" />
		<property name="addUpItemsString" value="${ADD_UP_ITEMS}" />
		<property name="paramsListString" value="${PARAM_LIST}" />
		<property name="removeFromParentString" value="${REMOVE_FROM_PARENT}" />
		<property name="addTheseItemsFromOptionsString" value="${ADD_ITEMS_FROM_OPTIONS}" />
	</bean>

	<!-- Publish/Subscribe Channel -->
	<bean id="publish" class="com.csc.eip.pattern.PublishSubscribe">
		<property name="factory" ref="connectionFactory" />
	</bean>

	<bean id="configProperties"
		class="org.springframework.beans.factory.config.PropertyPlaceholderConfigurer">
		<property name="location">
			<value>classpath:/application.properties</value>
		</property>
	</bean>

	<bean id="connectionFactory" class="com.rabbitmq.client.ConnectionFactory">
		<property name="host" value="${RABBITMQ_HOST}"></property>
		<property name="username" value="${RABBITMQ_USERNAME}"></property>
		<property name="password" value="${RABBITMQ_PASSWORD}"></property>
		<property name="port" value="${RABBITMQ_PORT}"></property>
	</bean>

	<!-- API Proxy Routers -->
	<bean id="apiProxyRouterAia" class="com.csc.eip.route.ApiProxyRouter">
		<property name="publicUriPrefix" value="https://devgateway.api.csc.com/insurance/omnichannel/aia"/>
		<property name="privateUriPrefix" value="http://20.33.40.152:10114/csc/insurance"/>
		<property name="proxyUriPrefix" value="/aia"/>
	</bean>
	<!-- AWS instance has been stopped
	<bean id="apiProxyRouterAiaAws" class="com.csc.eip.route.ApiProxyRouter">
		<property name="publicUriPrefix" value="https://devgateway.api.csc.com/insurance/omnichannel/aws/aia"/>
		<property name="privateUriPrefix" value="http://54.154.79.110:8080/csc/insurance"/>
		<property name="proxyUriPrefix" value="/aws/aia"/>
	</bean>
	-->

	<camelContext id="camelContext" streamCache="true"
		xmlns="http://camel.apache.org/schema/spring">
		<propertyPlaceholder id="properties"
			location="classpath:/application.properties" />

		<routeBuilder ref="apiProxyRouterAia"/>
		<!--
		<routeBuilder ref="apiProxyRouterAiaAws"/>
		-->
					
		<restConfiguration component="servlet" host="localhost" bindingMode="json">
			<dataFormatProperty key="prettyPrint" value="true" />
		</restConfiguration>

		<rest>
			<description>Message Translator Pattern</description>
			<post uri="/messageTranslator" 
				consumes="application/json" type="com.csc.eip.bo.Message" 
				produces="application/json" outType="com.csc.eip.bo.Message">
				<description>Replace all pattern matches in a JSON message</description>
				<route>
					<log message="/messageTranslator route started"/>
					<log message="pattern: ${header.pattern}"/>
					<log message="replacement: ${header.replacement}"/>
					<to uri="bean:messageTranslator?method=replacePattern(${body}, ${header.Pattern}, ${header.Replacement})" />
					<log message="/messageTranslator route ended"/>
				</route>
			</post>
		</rest>

		<rest>
			<description>Aggregator Pattern</description>
			<get uri="/aggregator" 
				produces="application/json" outType="com.csc.eip.bo.Message">
				<description>Combine the responses from multiple APIs into a single message</description>
				<route>
					<log message="/aggregator route started"/>
					<pipeline>
						<removeHeaders pattern="CamelHttp*"/>
						<setHeader headerName="CamelHttpMethod"><constant>GET</constant></setHeader>
						<enrich><constant>direct:serviceAggregate</constant></enrich>
					</pipeline>
					<log message="/aggregator route ended"/>
				</route>
			</get>
		</rest>

		<rest>
			<description>Publish Subscribe Channel Pattern</description>
			<post uri="/publish" produces="application/json"
				type="com.csc.eip.bo.Message" outType="com.csc.eip.bo.Message">
				<description>Deliver message to multiple consumers who have subscribed for the activity/event</description>
				<route>
					<to
						uri="bean:publish?method=publishMessage(${body}, ${properties:{${header.activity}}}, ${properties:{EXCHANGE_NAME}})" />
				</route>
			</post>
		</rest>

		<rest>
			<description>Pipes and Filter Pattern</description>
			<post uri="/pipeline" produces="application/json"
				type="com.csc.eip.bo.Message" outType="com.csc.eip.bo.Message">
				<description>Processing across multiple independent endpoint instances which are chained together</description>
				<route>
					<pipeline>
						<to
							uri="bean:messageTranslator?method=replacePattern(${body}, ${header.pattern}, ${header.replacement})" />
						<to
							uri="bean:publish?method=publishMessage(${body}, ${properties:{${header.activity}}}, ${properties:{EXCHANGE_NAME}})" />
					</pipeline>
				</route>
			</post>
		</rest>

		<route>
			<from uri="direct:serviceAggregate" />
			<recipientList delimiter="," strategyRef="aggregationStrategy"
				parallelProcessing="true" stopOnException="true">
				<header>RecipientList</header>
			</recipientList>
		</route>

	</camelContext>

</beans>