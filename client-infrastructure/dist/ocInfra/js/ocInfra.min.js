"use strict";function OCController(a,b,c,d,e,f,g,h){b.showHeader=!0;var i=null;c.screenId.indexOf(":")!==-1?(i=c.screenId.split(":"),b.screenId=i[1]):(i=c.screenId,b.screenId=i);var j=b.config.templates.metaModel;h.load(a,j),a.checkvisible=function(b){return g.checkVisibility(b,a)},a.doaction=function(b,c,d,e){"navigate"===b&&a.navigate(e)},b.navigate=function(a){d.path(a)}}function showHostErrorMessage(a,b){var c=$("#errorPopup");c.removeClass("alert-error"),c.removeClass("alert-warning"),c.removeClass("alert-info"),"30"===b?c.addClass("alert-error"):"20"===b?c.addClass("alert-remove"):c.addClass("alert-info"),$("#errorMessage").html(a),$("#errorPopup").show()}function loadOptions(a,b,c,d,e,f){if(void 0!==c){var g=b.metamodel[c];if(void 0!==g){var h=g.resourcelist;void 0!==h&&h.length>0&&loadOptionsDataForMetamodel(a,void 0,h,b,d,e,f)}}}function sanitizeSchema(a,b){return angular.forEach(b.schema.properties,function(c,d){d!==a&&delete b.schema.properties[d]}),b}function loadOptionsDataForMetamodel(a,b,c,d,e,f,g,h,i,j,k){return void 0!==c&&c.length>0&&angular.forEach(c,function(c){console.log("RESOURCE : "+c);var l,m,n;if(d.patchFieldName&&(n=d.patchFieldName),f.resourceHref)m=f.resourceHref;else{l=d.HostURL+c;var o=d.regionToSoR,p=o[e];m=l.replace(":regionId",p),f.resourceHref=m}console.log("OPTIONS CALL ON : "+m);var q=e+":"+c;void 0===d.optionsMap&&(d.optionsMap=[]);var r=d.optionsMap[q];(j||void 0!==i)&&(r=void 0),void 0===r&&(r=new Map),g.options(m,f.headers).success(function(c){var e,j=c.data||c,l=j._options.links;if(void 0!==i){var m=j._links[i];if(void 0!==m){var o=m.href;g.options(o,f.headers).success(function(c){var i=c.data||c,j=i._links.item.href;g.options(j,f.headers).success(function(c){var i=c.data||c;l=i._options.links,setOptionsMapForResource(l,r),d.optionsMap[q]=r,void 0!==h&&(e=r.get(h),void 0!==e&&void 0!==n?(e=sanitizeSchema(n,e),httpMethodToBackEnd(a,b,d,g,f,e,k)):k&&k())})})}else setOptionsMapForResource(l,r),d.optionsMap[q]=r,void 0!==h&&(e=r.get(h),void 0!==e&&httpMethodToBackEnd(a,b,d,g,f,e,k))}else setOptionsMapForResource(l,r),d.optionsMap[q]=r,void 0!==h&&(e=r.get(h),void 0!==e&&httpMethodToBackEnd(a,b,d,g,f,e,k))})}),"success"}function setOptionsMapForResource(a,b){angular.forEach(a,function(a){var c={};c.action=a.rel,c.url=a.href,c.httpmethod=a.method,c.schema=a.schema,console.log("ACTION : "+c.action),console.log("HTTP METHOD : "+c.httpmethod),console.log("URL : "+c.url),console.log("SCHEMA : "+c.schema),void 0!==b.get(c.action)?b.set(c.action,c):b.set(c.action,c)})}function convertToArray(a){if(void 0!==a&&void 0===a.length){var b=[];return b.push(a),b}return a}function invokeHttpMethod(a,b,c,d,e,f,g,h){var i=g.href,j=g.httpmethod;console.log(g.action+" Action : Perform "+j+" operation on URL - "+i+" with following params - ");var k={};g.properties=setDataIntoProperties(g.properties,e),k=setDataToParams(c,g.properties,k),"GET"===j?(f.loader.loading=!0,console.log("Invoke GET Call---"),d.get(i,k,f.headers).success(function(a){var b=a.data||a;if(console.log("GET Call Successful---"),f.loader.loading=!1,"search"===g.action)return b._links.item}).error(function(){f.loader.loading=!1,a.error(f.locale.GET_OPERATION_FAILED)})):"POST"===j?(f.loader.loading=!0,d.post(i,k,f.headers).success(function(b){var d=b.data||b;d&&("us"===f.regionId?(void 0!==d._links.self.quoteNumber&&(c.data["quote:identifier"]=d._links.self.quoteNumber,c.data["quote:annual_cost"]=d._links.self.premium),"success"===d.outcome?angular.forEach(d.messages,function(b){a.success(b.message)}):a.error(f.locale.CREATE_OPERATION_FAILED)):(f.resourceHref=d._links.self.href,f.loader.loading=!1,h&&h()))}).error(function(){f.loader.loading=!1})):"PATCH"===j?(f.loader.loading=!0,d.patch(i,k,f.headers).success(function(b){var c=b.data||b;c&&("success"===c.outcome?angular.forEach(c.messages,function(b){a.success(b.message)}):angular.forEach(c.messages,function(b){a.error(b.message)}),f.loader.loading=!1,h&&h())}).error(function(){f.loader.loading=!1,a.error(f.locale.PATCH_OPERATION_FAILED)})):"DELETE"===j&&d["delete"](i,f.headers).success(function(d){var e=d.data||d;if("success"===e.outcome){var f=0;angular.forEach(c.stTableList,function(a){b.$$hashKey===a.$$hashKey?c.stTableList.splice(f,1):f+=1}),angular.forEach(e.messages,function(b){a.success(b.message)})}else angular.forEach(e.messages,function(b){a.error(b.message)})})}function httpMethodToBackEnd(a,b,c,d,e,f,g){var h=f.url,i=f.httpmethod,j=f.schema;console.log(f.action+" Action : Perform "+i+" operation on URL - "+h+" with following params - ");var k={};k=setData(c,j,k),"GET"===i?(e.loader.loading=!0,d.get(h,k,e.headers).success(function(a){var b=a.data||a;e.loader.loading=!1,"search"===f.action&&(b._links.item?(c.stTableList=convertToArray(b._links.item),c.displayed=b._links.item,c.stTableList.showResult=!0):(c.stTableList=[],c.displayed=[],c.stTableList.showResult=!1))}).error(function(){e.loader.loading=!1,a.error(e.locale.GET_OPERATION_FAILED)})):"POST"===i?(e.loader.loading=!0,d.post(h,k,e.headers).success(function(b){b&&("us"===e.regionId?(void 0!==b._links.self.quoteNumber&&(c.data["quote:identifier"]=b._links.self.quoteNumber,c.data["quote:annual_cost"]=b._links.self.premium),"success"===b.outcome?angular.forEach(b.messages,function(b){a.success(b.message)}):a.error(e.locale.CREATE_OPERATION_FAILED)):(e.resourceHref=b._links.self.href,e.loader.loading=!1,g&&g()))}).error(function(){e.loader.loading=!1})):"PATCH"===i?(e.loader.loading=!0,d.patch(h,k,e.headers).success(function(b){b&&("success"===b.outcome?angular.forEach(b.messages,function(b){a.success(b.message)}):angular.forEach(b.messages,function(b){a.error(b.message)}),e.loader.loading=!1,g&&g())}).error(function(){e.loader.loading=!1,a.error(e.locale.PATCH_OPERATION_FAILED)})):"DELETE"===i&&d["delete"](h,e.headers).success(function(d){if("success"===d.outcome){var e=0;angular.forEach(c.stTableList,function(a){b.$$hashKey===a.$$hashKey?c.stTableList.splice(e,1):e+=1}),angular.forEach(d.messages,function(b){a.success(b.message)})}else angular.forEach(d.messages,function(b){a.error(b.message)})})}function loadReferencedMetaModels(a,b,c,d,e,f,g,h,i,j,k){var l,m=[];l=j?"assets/resources/metamodel/regions/"+j+"/":"assets/resources/metamodel/",angular.forEach(c.include,function(b){m.push(f(l+b+".json").get(function(a){h.metamodel[b]=a.metamodel},function(){h.showIcon=!1,a.error(h.appConfig.timeoutMsg)}).$promise)}),g.all(m).then(function(){setScreenData(h,b,c,d,i,e,k)})}function setScreenData(a,b,c,d,e,f,g){var h=c.metamodel,i=h.resourcelist;void 0!==i&&i.length>0&&angular.forEach(i,function(a){b.metamodel[a]=c.metamodel}),a.metamodel=b.metamodel=b.metamodel||{},b.metamodel[d]=c.metamodel,e.notifyWhenNoOutstandingRequests(function(){changeMandatoryColor(a),a.$apply()}),f&&f(c.metamodel),g&&g()}function setData(a,b,c){return void 0!==b&&angular.forEach(b.properties,function(b,d){var e=a.data[d],f=b.type;if(void 0!==f&&"static"===f&&(e=b.value),null===e||void 0===e||""===e||"undefined"===e);else{var g=b.format;void 0!==g&&"date"===g&&(e=formatIntoDate(e)),"object"==typeof e&&(e=void 0!==e.key?e.key:e.value),console.log(d+" : "+e),c[d]=e}}),c}function setDataIntoProperties(a,b){return void 0!==b&&void 0!==a&&angular.forEach(b,function(c,d){var e=b[d].value,f=a[d].metainfo.type;if(void 0!==f&&"static"===f&&(e=a[d].metainfo.value),null===e||void 0===e||""===e||"undefined"===e);else{var g=a[d].metainfo.format;void 0!==g&&"date"===g&&(e=formatIntoDate(e)),"object"==typeof e&&(e=void 0!==e.key?e.key:e.value),a[d].value=e}}),a}function setDataToParams(a,b,c){return void 0!==b&&angular.forEach(b,function(a,d){var e=b[d].value;null===e||void 0===e||""===e||"undefined"===e||(console.log(d+" : "+e),c[d]=e)}),c}function formatIntoDate(a){return"string"==typeof a?a:a.getFullYear()+"-"+("0"+(a.getMonth()+1)).slice(-2)+"-"+("0"+a.getDate()).slice(-2)}function changeMandatoryColor(a){void 0!==a.screenId&&($("#"+a.metamodel[a.screenId].formid+" input[ng-required='true']").css("background-color",a.requiredColor),$("#"+a.metamodel[a.screenId].formid+" select[ng-required='true']").css("background-color",a.requiredColor))}function LoginController(a,b,c,d,e,f,g,h,i,j,k,l){b.screenId="login";var m=b.metamodelPath;l.load(a,m),a.checkvisible=function(b){return j.checkVisibility(b,a)},b.showHeader=!1,a.doaction=function(b,c,d,e,f){"submit"===b&&a.submit(f)},a.submit=function(c){var d=$("form").attr("id");validateLogin(d),$("#"+d).valid()&&(navigator.onLine?i.runLogin(a,c):growl.error(b.locale.NETWORK_UNAVAILABLE,"30"))}}function ScreenController(a,b,c,d,e,f,g,h,i,j,k,l,m){function n(a){if(void 0!==a&&void 0===a.length){var b=[];return b.push(a),b}return a}function o(a){var b=c.metamodel[c.screenId].sections;angular.forEach(b,function(b){a===b.step&&(c.currRel=b.link,c.currName=b.$ref)})}c.enumData={},c.typeaheadData={},c.optionsMap=[],b.checkRegionId=c.regionId,b.showErr=function(){h.error("<b>Error:</b> Uh oh!"),h.info("Im  a info message"),h.warn("Im  a warn message"),h.success("Im  a success message")},screenname="OmniChannel",c.showHeader=!0,b.disableNext=!1,b.rulesDataList=[];var p=null,q=null,r=!1,s=!1;b.data={},b.remove="ban-circle",b.removestyle="red",b.dateOptions={changeYear:!0,changeMonth:!0,yearRange:"1900:2030"},c.typeahead=[],void 0!==f.regionId&&f.regionId.length>0&&(f.regionId.indexOf(":")!==-1?(q=f.regionId.split(":"),c.regionId=q[1],s=!0):(q=f.regionId,c.regionId=q)),f.screenId.indexOf(":")!==-1?(p=f.screenId.split(":"),c.screenId=p[1],r=!0):(p=f.screenId,c.screenId=p),f.screenId.indexOf("search")===-1&&f.screenId.indexOf("dashboard")===-1||(c.resourceHref=void 0),c.navigate=function(a,b){c.product_id=b,g.path(a)},b.getEnums=function(a){return c&&c.enumData&&c.enumData[a.name]?c.enumData[a.name]:a.options?a.options:void 0},b.getNamesList=function(a,d){if(d.typeahead){var e="",f="",g="",h="";if("referential_vehicle:make"===d.typeaheadField)g=d.typeaheadField+"="+a,f=g,e=c.HostURL+"referential_vehicle_makes?"+f;else if("referential_vehicle:model"===d.typeaheadField){h=d.typeaheadField+"="+a;for(var i=c.metamodel[c.currName].sections,k=0;k<i.length;k++)for(var l=i[k].elements,m=0;m<l.length;m++){var o=l[m];o.name===d.enableWhen.expression.field&&void 0!==o.typeaheadField&&null!==o.typeaheadField&&""!==o.typeaheadField&&(g=o.typeaheadField+"="+b.data[d.enableWhen.expression.field]+"&")}f=g+h,e=c.HostURL+"referential_vehicle_models?"+f}else e=c.HostURL+"persons?"+d.typeaheadField+"="+a;var p=c.regionToSoR,q=p[c.regionId];e=e.replace(":regionId",q),j.options(e,c.headers).success(function(a){var e=a.data||a;c.typeaheadData[d.typeaheadField]=[],b.typeaheadData[d.typeaheadField]=[];var f=n(e._links.item);angular.forEach(f,function(a){a.summary[d.typeaheadField]&&c.typeaheadData[d.typeaheadField].push(a.summary[d.typeaheadField])}),b.typeaheadData[d.typeaheadField]=c.typeaheadData[d.typeaheadField]})}},b.checkEnable=function(a){return!!a.enableWhen&&(void 0===b.data[a.enableWhen.expression.field]||null===b.data[a.enableWhen.expression.field]||""===b.data[a.enableWhen.expression.field])},i.setHeaders(c),b.loadTableMetadata=function(a){b.field={},k.load(a.name,function(a){b.field.tableMetaModel=a})},c.navigate=function(a,b){c.product_id=b,g.path(a)},b.checkvisible=function(a){return!a.visibleWhen||m.checkVisible(a,b)},c.isPrev=!1,b.loadOptionData=function(){var a=c.resourceHref;void 0===a&&(a=c.HostURL+b.screenId)},b.loadOptionData(),b.stTableList=[],b.displayed=[],b.stTableList.showResult=!0,b.doaction=function(a,d,e,f,g,k){console.log(g);var m=c.screenId,p=c.regionId;if("navigate"===e){var q=c.metamodel[m].resourcelist,r=c.HostURL+q,s=c.regionToSoR,t=s[p],u=r.replace(":regionId",t);c.resourceHref=u,c.navigate(f)}else if("nextTab"===e){var v=c.step+1,w=b.getRelationshipOfNavigateStep(v);b.selecttab(v,w)}else if("previousTab"===e){var x=c.step-1,y=b.getRelationshipOfNavigateStep(x);b.selecttab(x,y)}else{void 0===k&&(c.resourceHref=void 0),void 0!==f&&c.navigate(f);var z;void 0!==k&&Array.isArray(k)&&(z=k[0]),new Promise(function(a){var c=!1;b.patchFieldName=void 0,i.actionHandling(void 0,b,p,m,e,j,z,c,a)}).then(function(){void 0!==k?j.options(c.resourceHref,c.headers).success(function(a){var d=a.data||a,e=d._links[k[1]].href;j.options(e,c.headers).success(function(a){var d,e=a.data||a,f=e._links.item;d=Array.isArray(f)?f[0].href:f.href,j.options(d,c.headers).success(function(a){var d=a.data||a,e=d._links[k[2]].href,f={};j.post(e,f,c.headers).success(function(a){var d,e=a.data||a;d=Array.isArray(e.messages)?e.messages[e.messages.length-1].message[0]:e.messages.context,j.refresh(d,f,c.headers).success(function(a){var d=a.data||a;b.data=d,console.log("Compute successfully !!"),c.step=c.step+1,o(c.step),b.preStep=c.step,l.executeEnumerationFromBackEnd(d,"create")})}).error(function(a){var b="";if(a.Errors){var d=n(a.Errors);b=d.map(function(a){return a.Reason}).join("\n")}else b=c.locale.CALC_PREMIUM_OP_FAILED;h.error(b)})})})}):l.loadEnumerationByTab()})}},b.getRelationshipOfNavigateStep=function(a){for(var b=c.metamodel[c.screenId].sections,d=0;d<b.length;d++){var e=b[d];if(a===e.step)return e.link}},c.next=function(){b.next()},b.next=function(){},c.step=1,b.getenumdata=function(){var a="https://oc-sample-dropdown.getsandbox.com/omnichannel/sample/select";j.getData(a).success(function(a){var c=a.data||a;b.enumdata=c})},b.preStep=1,b.preRel=void 0,c.currRel=void 0,c.currName=void 0,new Promise(function(a){i.load(b,s?q[1]:q,r?p[1]:p,a)}).then(function(){if(o(b.preStep),"us"===c.regionId&&(c.currRel="itself"),c.screenId.indexOf("search")!==-1&&l.loadEnumerationByTab(),"undefined"!==c.currRel&&"itself"!==c.currRel&&"us"!==b.regionId)b.loadDataByTab(c.currRel);else if(void 0!==c.resourceHref){var a={};j.get(c.resourceHref,a,c.headers).success(function(a){var d=a.data||a;d&&(b.data=d,l.executeEnumerationFromBackEnd(d,"create"),"us"===c.regionId&&l.executeEnumerationFromBackEnd(d,"fetch"))})}}),b.selecttab=function(a,d){if(b.isValid())if(void 0!==t&&t.destroy(),c.step=a,c.currRel=d,o(b.preStep),b.preStep=c.step,o(b.preStep),"undefined"!==c.currRel&&"itself"!==c.currRel)b.loadDataByTab(c.currRel);else{var e={};j.get(c.resourceHref,e,c.headers).success(function(a){var c=a.data||a;c&&(b.data=c,l.executeEnumerationFromBackEnd(c,"create"))})}},b.patchField=function(a){b.patchFieldName=a,"us"!==c.regionId&&b.isValidByField(a)&&i.actionHandling(void 0,b,c.regionId,c.screenId,"update",j,c.currRel,!0)},b.loadDataByTab=function(a){var d=c.resourceHref;void 0!==d&&j.options(d,c.headers).success(function(d){var e=d.data||d;if(void 0!==e&&void 0!==e._links&&void 0!==e._links[a]){var f=e._links[a].href;j.options(f,c.headers).success(function(a){var d=a.data||a,e=d._links.item.href,f={};j.get(e,f,c.headers).success(function(a){var c=a.data||a;c&&(b.data=c,l.executeEnumerationFromBackEnd(c,"update"))})})}})};var t;b.isValid=function(){var a=[],d=b.loadmandatoryField(),e=[],f="";return angular.forEach(b.data,function(b,c){""!==b&&void 0!==b&&"_links"!==c&&"_options"!==c&&null!==b&&a.push(c)}),d.forEach(function(b){$.inArray(b,a)===-1&&(console.log(b),e.push(b))}),!(e.length>0)||(e.forEach(function(a){var d=b.translateKeyToLabelByTab(a);f+=c.locale[d]+c.locale.IS_REQD+"<br />"}),t=h.error(f),!1)},b.isValidByField=function(a){var d="";if(b.isMandatoryField(a)){if(void 0!==b.data[a]&&null!==b.data[a])return!0;var e=b.translateKeyToLabelByTab(a);return d=c.locale[e]+c.locale.IS_REQD,h.error(d),!1}return!0},b.isMandatoryField=function(a){var c=b.loadmandatoryField();return $.inArray(a,c)!==-1},b.loadmandatoryField=function(){for(var a=[],b=c.metamodel[c.currName].sections,d=0;d<b.length;d++)for(var e=b[d].elements,f=0;f<e.length;f++){var g=e[f];void 0!==g.required&&"required"===g.required&&a.push(g.name)}return a},b.translateKeyToLabelByTab=function(a){for(var b=c.metamodel[c.currName].sections,d=0;d<b.length;d++)for(var e=b[d].elements,f=0;f<e.length;f++){var g=e[f];if(g.name===a)return g.label}}}function showMessage(a){$("#messageID").html(a),$("#popupdiv").modal("show")}function validateLogin(a){$("#"+a).validate({focusInvalid:!1,onkeyup:!1,onclick:!1,focusCleanup:!1,onfocusout:!1,onfocus:!1,onsubmit:!1,rules:{inputUsername:{required:!0},inputPassword:{required:!0}},messages:{inputUsername:"Username and Password are required.",inputPassword:"Username and Password are required."},errorPlacement:function(a,b){$("#"+b.attr("id")).addClass("highlight")}})}LoginController.$inject=["$scope","$rootScope","$location","$cookieStore","$http","$resource","OCRoles","tmhDynamicLocale","LoginSrv","FieldService","OCInfraConfig","OCMetadata"],ScreenController.$inject=["$http","$scope","$rootScope","$controller","$injector","$routeParams","$location","growl","MetaModel","resourceFactory","TableMetaModel","EnumerationService","CheckVisibleService"];var app=angular.module("omnichannel",["ngRoute","ngResource","ui.bootstrap","ngSanitize","ui.select","mgcrea.ngStrap","ngLocale","tmh.dynamicLocale","colorpicker.module","smart-table","ui.date","ui.mask","QuickList","ngCookies","angular-growl"]).config(["$routeProvider","$locationProvider","$httpProvider","tmhDynamicLocaleProvider","growlProvider",function(a,b,c,d,e){e.globalTimeToLive(3e4),e.globalDisableCountDown(!0),e.onlyUniqueMessages(!0),a.when("/",{templateUrl:function(){return"ocInfra/templates/screen.html"},controller:LoginController}).when("/login",{templateUrl:function(){return"ocInfra/templates/screen.html"},controller:LoginController}).when("/:screenId",{templateUrl:function(){return"ocInfra/templates/screen.html"},controller:ScreenController}),d.localeLocationPattern("vendors/angular-i18n/angular-locale_{{locale}}.js")}]);app.run(["$rootScope","$location","$cookieStore","OCInfraConfig",function(a,b,c,d){a.$on("$locationChangeStart",function(){null!==sessionStorage.username&&void 0!==sessionStorage.username||b.url("/")}),a.showHeader=!1,d.load()}]),app.directive("capitalize",function(){return{require:"ngModel",link:function(a,b,c,d){var e=function(a){void 0===a&&(a="");var b=a.toUpperCase();return b!==a&&(d.$setViewValue(b),d.$render()),b};"true"===c.capitalize&&(d.$parsers.push(e),e(a[c.ngModel]))}}}),app.directive("decimalInput",function(){function a(a,b){var c;if(a){if(a+="",a.indexOf(",")>0&&a.indexOf(".")>0)a.lastIndexOf(",")>a.lastIndexOf(".")?(c=a.substring(0,a.lastIndexOf(",")).replace(/,/g,"").replace(/\./g,""),c+=a.substring(a.lastIndexOf(",")).replace(",",".")):(c=a.substring(0,a.lastIndexOf(".")).replace(/,/g,"").replace(/\./g,""),c+=a.substring(a.lastIndexOf(".")));else if(a.indexOf(",")>0)c=a.substring(0,a.lastIndexOf(",")).replace(/,/g,""),c+=a.substring(a.lastIndexOf(","),a.lastIndexOf(",")+b<a.length?a.lastIndexOf(",")+b+1:a.length).replace(",",".");else{if(!(a.indexOf(".")>0))return parseFloat(a);c=a.substring(0,a.lastIndexOf(".")).replace(/\./g,""),c+=a.substring(a.lastIndexOf("."),a.lastIndexOf(".")+b<a.length?a.lastIndexOf(".")+b+1:a.length)}return parseFloat(c)}}var b=/^\$?-?\d+([\.\,]{0,1}\d*){0,1}$/;return{restrict:"A",require:"ngModel",scope:{decimalPrecision:"=?",decimalMin:"=?",decimalMax:"=?"},link:function(c,d,e,f){c.decimalPrecision=c.decimalPrecision||2,c.decimalMin=c.decimalMin||0,c.decimalMax=c.decimalMax||9999999,f.$parsers.unshift(function(d){if(!d||""===d)return f.$setValidity("decimal",!0),d;if(b.test(d)){f.$setValidity("decimal",!0);var e=a(d,c.decimalPrecision);return e<c.decimalMin?(e=c.decimalMin,d=e+""):e>c.decimalMax&&(e=c.decimalMax,d=e+""),isNaN(parseInt(d.charAt(d.length-1)))||0===parseInt(d.charAt(d.length-1))?(d.indexOf(",")>0?d=d.split(",")[1].length>c.decimalPrecision?d.substring(0,d.indexOf(",")+c.decimalPrecision+1):d:d.indexOf(".")>0&&(d=d.split(".")[1].length>c.decimalPrecision?d.substring(0,d.indexOf(".")+c.decimalPrecision+1):d),f.$setViewValue(d),f.$render()):(f.$setViewValue(e+""),f.$render()),e}return 1===d.length&&"-"===d.charAt(0)?d:(isNaN(parseFloat(f.$modelValue))?f.$setViewValue("0"):f.$setViewValue(f.$modelValue+""),f.$render(),f.$modelValue)}),f.$formatters.unshift(function(a){if(a)return parseFloat(a).toFixed(c.decimalPrecision)})}}}),app.directive("formatDate",["$filter",function(a){return{require:"ngModel",link:function(b,c,d,e){e.$parsers.push(function(b){return a("date")(b,"yyyy-MM-dd")})}}}]),app.directive("inputRender",["$compile","$http","$rootScope","$templateCache","uibButtonConfig","$injector","$location","$timeout","resourceFactory",function(a,b,c,d,e,f,g,h,i){return{restrict:"E",replace:"true",scope:{property:"=",metamodel:"=",resources:"=",updateMode:"@",onUpdate:"@",baseUrl:"@",factoryName:"=",resourceUrl:"="},controller:["$scope",function(a){function b(){var b=[];return angular.forEach(a.resources,function(a,c){c&&c.split(":").length>2&&b.push(c)}),b}function d(a,b){if("string"==typeof b){if(b in a)return a[b];if(b.indexOf(".")>0){var c=b.substring(0,b.indexOf("."));if(c in a)return a.$eval(b);if(a.$parent)return d(a.$parent,b)}else if(a.$parent)return a.$parent.resourcesToBind&&b in a.$parent.resourcesToBind.properties?a.$parent.resourcesToBind.properties[b]:d(a.$parent,b)}}function j(a,b,c){var e=!0;if(a.operator)"AND"===a.operator?angular.forEach(a.conditions,function(a){e&&(e=e&&j(a,b,c))}):"OR"===a.operator&&(e=!1,angular.forEach(a.conditions,function(a){e||(e=e||j(a,b,c))}));else if(a.existsInEntity)e=c&&c[a.field]&&null!==c[a.field].value;else{var f;f=c&&c[a.field]?c[a.field]:d(b,a.field);var g=f instanceof Object?f.value:f;e=g===a.value}return e}var k={};k.autocomplete={attributes:{"typeahead-wait-ms":1e3,"typeahead-focus-first":!1,"typeahead-min-length":3,maxlength:9999999,capitalize:!1},options:{_getData:function(b,c,d){return d.options.getData?d.options.getData({$viewValue:b,field:d,resources:a.resources}).then(function(a){return a=a||[],a&&!Array.isArray(a)?[a]:a}):d.options.href&&d.options.params?a.getData({$viewValue:b,field:d}):void 0},_select:function(a,b,c){c.options.select?c.options.select({$item:a,id:b,field:c,property:c.property,$injector:f}):console.warn("input.js -> autocomplete_select(): No select callback for autocomplete input.")},_typeaheadBlur:function(a,b){b.options.typeaheadBlur?b.options.typeaheadBlur({event:a,id:b.id,$injector:f}):a&&a.target&&a.target.attributes&&a.target.attributes["aria-owns"]||console.warn("input.js -> autocomplete_typeaheadBlur(): Typeahead dropdown not found in view.")},_typeaheadFocus:function(a,b){if(b.options.typeaheadFocus)b.options.typeaheadFocus({event:a,id:b.id,$injector:f});else if(a&&a.target&&a.target.attributes&&a.target.attributes["aria-owns"]){var c=document.getElementById(a.target.attributes["aria-owns"].value);angular.element(c).scope().moveInProgress=!1}else console.warn("input.js -> autocomplete_typeaheadFocus(): Typeahead dropdown not found in view.")}}},k.decimal={attributes:{decimalprecision:2,minimum:0,maximum:9999999},options:{}},k.money={attributes:{currency:["eur","usd","gbp","yen","rub","won"],decimalprecision:2,minimum:0,maximum:9999999},options:{}},k.email={attributes:{maxlength:9999999},options:{}},k.number={attributes:{min:0,max:9999999},options:{}},k.percentage={attributes:{decimalprecision:2,minimum:0,maximum:9999999},options:{}},k.select={attributes:{capitalize:!1},options:{_getData:function(a,b){return b.options.getData?b.options.getData({id:a,property:b.property,$injector:f}):b.attributes["enum"]}}},k.radio={attributes:{capitalize:!1},updateMode:"change"},k.textMask={attributes:{capitalize:!0,mask:""},options:{}},k.text={attributes:{capitalize:!0,maxlength:9999999},options:{},format:"text"},k.textarea={attributes:{maxlength:9999999},options:{}},k.toggle={attributes:{true_label:"_TRUE",false_label:"_FALSE"},options:{},updateMode:"change"},k.date={attributes:{dateformat:"dd/MM/yyyy",startWeek:1,trigger:"focus",autoclose:!0},options:{}},k.checkbox={attributes:{},options:{},updateMode:"change"},k.label={attributes:{},options:{}},k.multiselect={attributes:{showcheckbox:!1},options:{_onclick:function(){}}},k.range={attributes:{},options:{}},a.patch=function(c,d){a.timeout||(a.timeout=!0,h(function(){a.timeout=!1;var e={};i.get(c.property.self).then(function(f){var g=f.data,h=b();for(var j in g)if(j.indexOf(":")>0&&0!==j.indexOf("_"))if(j in a.resources&&a.resources[j].value!==g[j]&&a.resources[j].editable)e[j]=a.resources[j].value?a.resources[j].value:null;else for(var k in h){var l=h[k],m=l.split(":")[0]+":"+l.split(":")[1];j===m&&c.property.self===a.resources[l].self&&a.resources[l].editable&&(e[j]=a.resources[l].value?a.resources[l].value:null)}Object.keys(e).length>0&&i.patch(c.property.self,e,{}).then(function(){d&&d(c)},function(a){console.error(a),i.refresh(c.property.self,{},{})})})},"autocomplete"===c.scope.metamodel.type?500:0))},a.getData=function(a){var b=c.hostURL+a.field.options.href+"?"+a.field.options.params+"="+a.$viewValue;return i.get(b).then(function(a){a=a.data||a;var b=a._links.item||[];return b&&!Array.isArray(b)?[b]:b})},a.load=function(){e.activeClass="btn-active",void 0!==g.path().split("/screen/")[1]?a.screenFactoryName=g.path().split("/screen/")[1].split("/")[0]+"Factory":a.screenFactoryName=g.path().split("/")[0]+"Factory",a.actionFactory={},a.factoryName=a.metamodel.factoryName||a.factoryName||a.screenFactoryName;try{a.actionFactory=f.get(a.factoryName)}catch(b){console.warn(a.factoryName+" not found")}!a.property&&a.resources&&(console.log('input.js -> load(): Property "'+a.metamodel.id+'" not found. Creating it...'),a.resources[a.metamodel.id]={required:!1,editable:!0,metainfo:{},value:a.metamodel.value},a.property=a.resources[a.metamodel.id]);var h=a.metamodel.type||a.property.metainfo.type;a.baseUrl=a.baseUrl||c.templatesURL,a.inputHtmlUrl=a.baseUrl+"input-"+h+".html",a.updateMode=a.updateMode&&""!==a.updateMode?a.updateMode:k[h].updateMode,a.updateMode=a.updateMode&&""!==a.updateMode?a.updateMode:"blur",a.onUpdate&&""!==a.onUpdate&&!a.update&&(a.update=a.actionFactory[a.onUpdate],a.update||(a.update=d(a,a.onUpdate))),a.field={property:a.property,label:a.metamodel.label,id:a.metamodel.id,name:a.metamodel.name||a.metamodel.id||"",placeholder:a.metamodel.placeholder,resourceUrl:a.resourceUrl,onBlur:function(){"blur"===a.updateMode&&(a.metamodel.patchOnBlur?a.patch({id:a.field.id,property:a.field.property,$injector:f,scope:a},a.update):a.update&&a.update({id:a.field.id,property:a.field.property,$injector:f,scope:a}))},onChange:function(){"change"===a.updateMode&&(a.metamodel.patchOnBlur?a.patch({id:a.field.id,property:a.field.property,$injector:f,scope:a},a.update):a.update&&a.update({id:a.field.id,property:a.field.property,$injector:f,scope:a}))},isVisible:function(){return a.metamodel.visible||!a.metamodel.visibleWhen||j(a.metamodel.visibleWhen.expression,a,a.resources)},getParentResource:function(){return i.get(a.field.property.self)},attributes:{},options:{},labelsize:a.metamodel["label-size"]&&"lg"===a.metamodel["label-size"]?8:4,icon:a.metamodel.icon,"class":a.metamodel.classInput,format:a.metamodel.format||k[h].format,tooltip:a.metamodel.tooltip};var l=angular.copy(k[h].attributes);a.field.attributes=l;for(var m in l)l[m]&&Array.isArray(l[m])&&(l[m.toLowerCase()]=l[m][0]);if(void 0!==a.property&&void 0!==a.property.metainfo)for(var n in a.property.metainfo)"type"!==n&&(l[n.toLowerCase()]=a.property.metainfo[n]);if(void 0!==a.metamodel.attributes)for(var o in a.metamodel.attributes)l[o]&&Array.isArray(l[o])?l[o.toLowerCase()]=l[o].indexOf(a.metamodel.attributes[o])>=0?a.metamodel.attributes[o]:l[o][0]:l[o.toLowerCase()]=a.metamodel.attributes[o];var p=angular.copy(k[h].options);a.field.options=p;for(var q in a.metamodel.options){var r=q;do r=0===r.indexOf("_")?r.substring(1):r;while(0===r.indexOf("_"));a.field.options[r]=a.actionFactory[a.metamodel.options[q]]||d(a,a.metamodel.options[q])||a.metamodel.options[q]}},a.$watchGroup(["property","metamodel"],function(b){(b[0]&&b[1]||void 0===b[0]&&b[1]&&b[1].uiInput)&&a.load()})}],link:function(e,f){var g=e.$watch("inputHtmlUrl",function(h){h&&(d.get(h)?("Pending"===d.get(h)?c.$on(h,function(b){f.html(d.get(b.name)),a(f.contents())(e)}):(f.html(d.get(h)),a(f.contents())(e)),g()):(d.put(h,"Pending"),b.get(h).then(function(b){d.put(h,b.data),c.$broadcast(h,b.data),f.html(b.data),a(f.contents())(e),g()})))})}}}]),app.directive("popupRender",["MetaModel","$resource","$rootScope","$location","$injector",function(a,b,c,d,e){return{restrict:"E",scope:{uiId:"@",metamodel:"=",resourceUrl:"=",factoryName:"="},controller:["$scope",function(b){function d(){var a=b.metamodelObject.actions&&b.metamodelObject.actions.ok&&b.metamodelObject.actions.ok.callback?b.metamodelObject.actions.ok.callback:null;b.$broadcast("patch_renderer",{resourceUrl:b.resourceUrl||c.resourceUrl,callback:a})}function f(){var a=b.metamodelObject.actions&&b.metamodelObject.actions.close&&b.metamodelObject.actions.close.callback?b.metamodelObject.actions.close.callback:null;b.$broadcast("close_popUp_renderer",{resourceUrl:b.resourceUrl,callback:a})}function g(){if(b.metamodelObject.actions.reset.links){var a=b.metamodelObject.actions.reset.callback?b.metamodelObject.actions.reset.callback:null;b.$broadcast("reset_renderer",{resourceUrl:b.resourceUrl,links:b.metamodelObject.actions.reset.links,callback:a})}}function h(a){b.metamodelObject=a,i(),j(),b.screenFactoryName=b.metamodelObject.factoryName||b.factoryName;try{b.actionFactory=e.get(b.screenFactoryName)}catch(c){console.log(b.screenFactoryName+"not found")}}function i(){b.popup.labels.titleDefault="_POPUP_TITLE",b.popup.labels.ok="_SAVE",b.popup.labels.close="_CLOSE",b.popup.labels.reset="_RESET",b.popup.actions._ok=d,b.popup.actions._close=f,b.popup.actions._reset=g,b.metamodelObject.labels&&(b.popup.labels.title=b.metamodelObject.labels.title||b.popup.labels.titleDefault,b.popup.labels.ok=b.metamodelObject.labels.ok||b.popup.labels.ok,b.popup.labels.close=b.metamodelObject.labels.close||b.popup.labels.close,b.popup.labels.cancel=b.metamodelObject.labels.cancel||b.popup.labels.cancel,b.popup.labels.reset=b.metamodelObject.labels.reset||b.popup.labels.reset)}function j(){b.metamodelObject.actions&&(b.popup.actions._ok=b.metamodelObject.actions.ok&&b.metamodelObject.actions.ok.method?b.metamodelObject.actions.ok.method:b.popup.actions._ok,b.popup.actions._close=b.metamodelObject.actions.close&&b.metamodelObject.actions.close.method?b.metamodelObject.actions.close.method:b.popup.actions._close,b.popup.actions._cancel=b.metamodelObject.actions.cancel&&b.metamodelObject.actions.cancel.method?b.metamodelObject.actions.cancel.method:b.popup.actions._cancel,b.popup.actions._reset=b.metamodelObject.actions.reset&&b.metamodelObject.actions.reset.method?b.metamodelObject.actions.reset.method:b.popup.actions._reset)}function k(){if(b.popUpResourceToBind&&b.metamodelObject.actions&&b.metamodelObject.actions.reset)for(var a=0;a<b.metamodelObject.actions.reset.links.length;a++)for(var c=0;c<b.popUpResourceToBind.dependencies.length;c++)if(b.popUpResourceToBind.dependencies[c].resource===b.metamodelObject.actions.reset.links[a])return!1;return!0}b.popup={id:b.uiId||"_popup"+Math.floor(1e12*Math.random()),labels:{},actions:{}},b.resultSet={},b.resetDisabled=!1;var l=c.metamodel?c.metamodel[b.metamodel]:null;l?h(l):a.load(c,c.regionId,b.metamodel,function(a){h(a)}),b.$on("resource_directory",function(c,d){b.resourceUrl&&d.url.indexOf(b.resourceUrl)>=0&&"DELETE"!==d.response.config.method&&(b.resultSet={},a.prepareToRender(b.resourceUrl,b.metamodelObject,b.resultSet))}),b.$watch("resourceUrl",function(){b.metamodelObject&&b.resourceUrl&&a.prepareToRender(b.resourceUrl,b.metamodelObject,b.resultSet)}),b.$on("refresh_popUp",function(c,d){d.name===b.metamodelObject.name&&a.prepareToRender(b.resourceUrl,b.metamodelObject,b.resultSet,null,!0)}),b.$watchCollection("resultSet",function(a){if(a[b.resourceUrl]&&a[b.resourceUrl].properties){var c=a[b.resourceUrl].properties[b.metamodelObject.type]?a[b.resourceUrl].properties[b.metamodelObject.type].value:"";c?b.popup.labels.title=c.toUpperCase()+"_"+(b.metamodelObject.labels.title||b.popup.labels.titleDefault):b.popup.labels.title=b.metamodelObject.labels.title||b.popup.labels.titleDefault,
b.popUpResourceToBind=a[b.resourceUrl],b.resetDisabled=k()}}),b.execute=function(a){"function"==typeof a?a():b.actionFactory[a]&&b.actionFactory[a](b.resultSet[b.resourceUrl],b.popUpResourceToBind.properties)}}],templateUrl:c.templatesURL+"popup.html"}}]),angular.module("omnichannel").directive("renderer",["MetaModel","$resource","$rootScope","$injector","resourceFactory","$q","$location",function(a,b,c,d,e,f,g){return{restrict:"E",scope:{metamodel:"=",resourceUrl:"=?",factoryName:"="},link:function(b){function h(a){a&&a.sections&&a.sections.forEach(function(a){if(!a.type||"reference"!==a.type){var b=[];a.rows=[],a.properties.forEach(function(a){void 0!==a.row&&(void 0===b[a.row]&&(b[a.row]=0),b[a.row]++),a.id&&!Array.isArray(a.id)&&(a.id=[a.id])});for(var c=function(a){if(void 0!==a.row&&a.row===d)return a},d=0;d<b.length;d++)if(void 0!==b[d]){var e=a.properties.map(c);a.rows.push(e);for(var f=0;f<e.length;f++)if(void 0!==e[f]){a.properties.splice(a.properties.indexOf(e[f]),1);var g=12;a.properties.length>1&&e[f].row&&(g=12/(b[e[f].row]>4?4:b[e[f].row])),e[f].colspan=e[f].colspan||g,a.properties.push(e[f])}}for(var h=a.properties.length-1;h>=0;h--)void 0===a.properties[h].row&&a.rows.unshift([a.properties[h]]);a.rows.forEach(function(a){for(;a.indexOf(void 0)>=0;)a.splice(a.indexOf(void 0),1)})}})}function i(f){b.factoryName=b.factoryName||f.factoryName;try{b.actionFactory=d.get(b.factoryName)}catch(g){console.log(b.factoryName+" not found")}b.optionsMap={},b.metamodelObject=f;var h=b.metamodelObject.resource;b.resourcesToBind={properties:{}};var i={};if(void 0!==c.regionId&&void 0!==h){var k=c.hostURL+h,l=c.regionToSoR,m=l[c.regionId];i=k.replace(":regionId",m),b.metamodelObject.optionUrl=i,b.resourceUrlToRender=i}else void 0!==h&&(i=c.hostURL+h,b.metamodelObject.optionUrl=i,b.resourceUrlToRender=i);b.optionUrl=b.metamodelObject.optionUrl,void 0!==b.optionUrl&&(b.$watchCollection("optionsMap",function(a){a&&Object.keys(a).forEach(function(c){var d=a[c];if(void 0!==d&&b.metamodelObject.actionOnScreen){var f=d.get(b.metamodelObject.actionOnScreen);if(void 0!==f){console.log("optionsMap action"+f.action);var g=JSON.parse(sessionStorage.getItem(h+"_"+f.action+"_data")),i=JSON.parse(sessionStorage.getItem(h+"_"+f.action+"_params"));sessionStorage.removeItem(h+"_"+f.action+"_params"),sessionStorage.removeItem(h+"_"+f.action+"_params"),e.execute(f.href,g,i,null,f.httpmethod).then(function(a){"POST"===f.httpmethod?(b.resourceUrl=a.data._links.self.href,sessionStorage.setItem(h+"_get_url",b.resourceUrl)):(b.metamodelObject.resourceUrl=f.href,b.resourcesToBind[b.metamodelObject.resourceUrl]=f,b.resourcesToBind[b.metamodelObject.resourceUrl].properties=f.properties),j(b.metamodelObject)})}}})}),a.prepareOptions(b.optionUrl,b.optionsMap))}function j(e){b.metamodelObject=e,b.resultSet={},b.boundUrls=[],b.metamodelObject.resourceUrl&&b.metamodelObject.resourceUrl.indexOf(c.hostURL)===-1&&(b.metamodelObject.resourceUrl=c.hostURL+b.metamodelObject.resourceUrl),b.resourcesToBind={properties:{}},b.boundUrls.push(b.resourceUrl),b.factoryName=e.factoryName||b.factoryName;try{b.actionFactory=d.get(b.factoryName)}catch(f){console.log(b.factoryName+" not found")}b.screenName=g.path().substring(g.path().lastIndexOf("/")+1),b.resourceUrlToRender=b.resourceUrl||b.metamodelObject.resourceUrl||c.resourceUrl,void 0!==b.resourceUrlToRender&&""!==b.resourceUrlToRender&&(b.$watchCollection("resultSet",function(a){if(a){var c={};if(b.resourcesToBind&&b.resourcesToBind.properties)for(var d in b.resourcesToBind.properties)d.indexOf(":")===-1&&(c[d]=b.resourcesToBind.properties[d]);b.resourcesToBind={properties:c};for(var e in a)"deferred"!==e&&"pending"!==e&&(b.resourcesToBind[a[e].identifier]=a[e]);b.boundUrls=[],b.boundUrls.push(b.resourceUrl),b.propertiesCollection=[];for(var f=function(a){a.id&&!Array.isArray(a.id)&&(a.id=[a.id]),k(a)},g=0;g<b.metamodelObject.sections.length;g++)if(!b.metamodelObject.sections[g].type||"reference"!==b.metamodelObject.sections[g].type)for(var h=0;h<b.metamodelObject.sections[g].properties.length;h++)if(!b.metamodelObject.sections[g].properties[h].uiInput){k(b.metamodelObject.sections[g].properties[h]);for(var i in b.metamodelObject.sections[g].properties[h].attributes)Array.isArray(b.metamodelObject.sections[g].properties[h].attributes[i])&&b.metamodelObject.sections[g].properties[h].attributes[i].forEach(f)}}}),b.$on("resource_directory",function(c,d){b.boundUrls.indexOf(d.url)>=0&&"DELETE"!==d.response.config.method&&a.prepareToRender(b.resourceUrlToRender,b.metamodelObject,{}).then(function(a){b.resultSet=a})}),a.prepareToRender(b.resourceUrlToRender,b.metamodelObject,b.resultSet))}function k(a){if(!a.uiInput&&Array.isArray(a.id))for(var c=a.id,d=0;d<c.length;d++){var e={resource:null,points:0};for(var f in b.resourcesToBind)"properties"!==f&&(a.selector?l(b.resourcesToBind[f],a.selector,e):a.id[d]in b.resourcesToBind[f].properties&&(e.resource=f));if(b.resourcesToBind.properties=b.resourcesToBind.properties||{},e.resource&&a.id[d]in b.resourcesToBind[e.resource].properties){var g=a.complexId&&a.complexId[d]?a.complexId[d]:a.id[d];b.resourcesToBind.properties[g]=b.resourcesToBind[e.resource].properties[a.id[d]],b.boundUrls.indexOf(b.resourcesToBind.properties[g].self)<0&&b.boundUrls.push(b.resourcesToBind.properties[g].self);break}}}function l(a,b,c){var d=Array.isArray(b)?b:[b],e=0;return d.forEach(function(b){a.properties[b]&&(e+=2,a.properties[b].value===!0&&(e+=1))}),e>=c.points&&(c.resource=a.identifier,c.points=e,!0)}var m=c.metamodel?c.metamodel[b.metamodel]:null;m?(h(m),i(m),j(m)):a.load(c,c.regionId,b.metamodel,function(a){h(a),i(a),j(a)}),b.$watch("resourceUrl",function(a,c){a!==c&&b.metamodelObject&&j(b.metamodelObject)}),b.isVisible=function(a){return void 0!==a},b.execute=function(c,d){if(b.actionFactory&&b.actionFactory[c]){var e=a.getDefaultValues(c,b.metamodelObject);void 0!==b.resourcesToBind.properties&&b.actionFactory[c](b,d,b.optionsMap[b.optionUrl],b.resourcesToBind.properties,e)}else b[c]&&void 0!==b.resultSet&&void 0!==b.resourceUrlToRender&&void 0!==b.resultSet[b.resourceUrlToRender]&&void 0!==b.resourcesToBind.properties&&b[c](b.resourcesToBind.properties);var f=b.optionsMap[b.optionUrl];if(void 0!==f&&void 0!==d){var g=f.get(d);void 0!==g&&(b.resourceUrl=g.href)}},b.$on("patch_renderer",function(a,c){if(c.resourceUrl===b.resourceUrlToRender||c.save){var d={},g=[],h=b.resourcesToBind.properties;if(h){for(var i in h)if(h[i]&&h[i].self&&h[i].editable){var j=h[i].self;d[j]=d[j]||{}}var k=Object.keys(d);k.forEach(function(a){e.get(a).then(function(i){var j=i.data,k=d[a];for(var l in j)l.indexOf(":")>0&&0!==l.indexOf("_")&&l in h&&h[l].value!==j[l]&&(k[l]=b.resourcesToBind.properties[l].value?b.resourcesToBind.properties[l].value:null);Object.keys(k).length>0&&(g.push(e.patch(a,k)),f.all(g).then(function(){c.callback&&b.execute(c.callback)}))})})}}}),b.$on("close_popUp_renderer",function(a,c){c.resourceUrl===b.resourceUrlToRender&&c.callback&&b.execute(c.callback)}),b.$on("reset_renderer",function(a,c){if(c.resourceUrl===b.resourceUrlToRender){var d={};if(b.resourcesToBind){for(var f in c.links)b.resourcesToBind[c.links[f]]&&(d[c.links[f]]="");e.patch(c.resourceUrl,d).then(function(){c.callback&&b.execute(c.callback)})}}})},templateUrl:c.templatesURL+"renderer.html"}}]),angular.module("omnichannel").directive("tableRender",["MetaModel","$resource","$location","$injector","$rootScope","resourceFactory",function(a,b,c,d,e,f){return{restrict:"E",replace:"true",scope:{metamodel:"=",resourceUrl:"=",factoryName:"="},controller:["$scope",function(b){function c(c){b.resultSet={},b.itemSelected={},b.metamodelObject=c;var f=b.metamodelObject.modalRef;if(f){var j=e.metamodel?e.metamodel[f]:null;j?b.modalMetamodelObject=j:a.load(e,e.regionId,f,function(a){b.modalMetamodelObject=a})}b.resourceUrl=b.resourceUrl||b.metamodelObject.resourceUrl,a.prepareToRender(b.resourceUrl,b.metamodelObject,b.resultSet),b.$watchCollection("resultSet",function(a){a&&a[b.resourceUrl]&&(b.table=angular.copy(a[b.resourceUrl]),b.table.items=[],a[b.resourceUrl].items.forEach(function(c){b.metamodelObject.filters?h(c).then(function(b){b||g(a,c)}):g(a,c)})),i()}),b.factoryName=c.factoryName||b.factoryName;try{b.actionFactory=d.get(b.factoryName)}catch(k){console.log(b.factoryName+" not found")}}function g(a,c){var d=angular.copy(a[c.href]),e=l(a,d);b.itemResourcesToBind={properties:{}};for(var f in e)b.itemResourcesToBind[e[f].identifier]=e[f];for(var g=0;g<b.metamodelObject.properties.length;g++){var h=b.metamodelObject.properties[g],i=h.id;Array.isArray(h.id)||(i=[h.id]),j(h.type)&&(h.id=i);for(var m=0;m<i.length;m++){var n=k(i[m]);n&&n.properties&&i[m]in n.properties&&(b.itemResourcesToBind.properties[i[m]]=n.properties[i[m]])}}Object.keys(b.itemResourcesToBind.properties).length>0&&(d.properties=b.itemResourcesToBind.properties),d&&b.table.items.push(d)}function h(a){var c=b.metamodelObject.filters;return f.get(a.href).then(function(a){if(!c)return!1;for(var d in c){var e=b.metamodelObject.filters[d];return e.indexOf(a.data[d])===-1}})}function i(){if(b.buttons=[],b.metamodelObject.buttons){var a=b.metamodelObject.buttonLabel;f.get(b.resourceUrl).then(function(c){c.data._options.links.forEach(function(c){if("create"===c.rel){var d={};if(c.schema.required&&c.schema.required.length>0){var e=c.schema.required[0];if(c.schema.properties&&e in c.schema.properties){var f=c.schema.properties[e];f["enum"]&&f["enum"].forEach(function(a){d={},d[e]=a,b.buttons.push({label:"ADD_"+a.toUpperCase().trim(),action:{value:"add",buttonAction:!0,params:d}})})}}0===b.buttons.length&&b.buttons.push({label:a,action:{value:"add",buttonAction:!0,params:d}})}})})}}function j(a){return"status"!==a&&"icon"!==a&&"literal"!==a&&"blank"!==a&&"actions"!==a}function k(a){var c=null,d=null;for(var e in b.itemResourcesToBind)if("properties"!==e&&a in b.itemResourcesToBind[e].properties){c=b.itemResourcesToBind[e];for(var f in c.properties)f.indexOf("preferred")!==-1&&c.properties[f].value&&(d=c)}return d||c}function l(a,b){var c={};return b&&b.href&&(c[b.href]=b,b.dependencies&&b.dependencies.forEach(function(b){for(var d in a)d.indexOf(b.href)!==-1&&(c[d]=a[d])})),c}var m=e.metamodel?e.metamodel[b.metamodel]:null;m?c(m):a.load(e,e.regionId,b.metamodel,function(a){c(a)}),b.$on("resource_directory",function(c,d){(d.url===b.resourceUrl||d.previous&&d.previous.data&&d.previous.data._links.up.href===b.resourceUrl||d.response.data._links&&d.response.data._links.up.href===b.resourceUrl||b.resultSet&&d.url in b.resultSet)&&("DELETE"===d.response.config.method||"PATCH"===d.response.config.method||"POST"===d.response.config.method?(b.inProgress=!0,a.prepareToRender(b.resourceUrl,b.metamodelObject,{},null,!0).then(function(a){b.resultSet=a,b.inProgress=!1})):b.inProgress||(b.inProgress=!0,a.prepareToRender(b.resourceUrl,b.metamodelObject,{}).then(function(a){b.resultSet=a,b.inProgress=!1})))}),b.$on("refresh_table",function(c,d){d.name===b.metamodelObject.name&&(b.inProgress=!0,a.prepareToRender(b.resourceUrl,b.metamodelObject,{},null,!0).then(function(a){b.resultSet=a,b.inProgress=!1}))}),b.execute=function(a,c){a.buttonAction?b.metamodelObject.buttonMethod?b.actionFactory[b.metamodelObject.buttonMethod](a.params):b[a.value](a.params,b.metamodelObject.buttonCallback):a.method?b.actionFactory[a.method](c):b[a.value](c,a.callback)},b.isValidStatus=function(a){var c=!0;if(a){var d=a.properties;b.modalMetamodelObject&&b.modalMetamodelObject.sections.forEach(function(a){a.properties&&a.properties.forEach(function(a){var b=a.id;Array.isArray(b)||(b=[b]),b.forEach(function(a){d[a]&&(c=c&&d[a].consistent)})})})}return c},b.edit=function(a,c){b.itemSelected=a,c&&b.actionFactory[c]&&b.actionFactory[c](a)},b["delete"]=function(a,c){a.deletable&&f["delete"](a.href).then(function(a){c&&b.actionFactory[c]&&b.actionFactory[c](a)})},b.add=function(a,c){f.get(b.resourceUrl).then(function(d){d.data._options.links.forEach(function(d){if("create"===d.rel){var g=d.href;f.post(g,a,e.headers).then(function(a){var d=a.data._links.self.href;b.edit({href:d}),c&&b.actionFactory[c]&&b.actionFactory[c](a)})}})})}}],link:function(){},templateUrl:e.templatesURL+"table.html"}}]),app.directive("ocLogodir",function(){return{restrict:"E",template:'<div class="oc-logo" style="margin-left: auto;margin-right: auto;"></div>'}}),app.directive("formatDate",function(){return{require:"ngModel",link:function(a,b,c,d){d.$formatters.push(function(a){if(a){var b=new Date(a);return d.$modelValue=b,b}})}}}),app.factory("MetaModel",["$resource","$rootScope","$location","$browser","$q","resourceFactory","growl",function(a,b,c,d,e,f,g){function h(a,b){if(!b)return console.warn("No metamodel object to extract business dependencies"),[];if(!b.businessObject)return[];var c=[],d=[];for(var e in a)if(0!==e.indexOf("_")&&e.indexOf(":")>0){var f=e.split(":")[0];d.indexOf(f)===-1&&d.push(f)}return d.forEach(function(d){d in b.businessObject&&b.businessObject[d].forEach(function(b){b in a._links&&c.push({href:a._links[b].href,resource:b})})}),c}function i(a){var b=new Map;if(a&&a._options){var c=a._options.links;void 0!==c&&angular.forEach(c,function(a){var c={};if(void 0!==a){c.action=a.rel,c.href=a.href,c.httpmethod=a.method;var d=a.schema,e={};if(void 0!==d){var f=d.properties;void 0!==f&&angular.forEach(f,function(b,c){e[c]={},e[c].metainfo=d.properties[c],e[c].value="",e[c].url=a.href,e[c].required=d.required&&d.required.indexOf(c)>=0,e[c].editable=!0,e[c].statusMessages={information:[],warning:[],error:[],errorCount:0},e[c].consistent=!0}),c.properties=e}}console.log("Action: "+c.action),console.log("HREF: "+c.href),console.log("HTTP Method: "+c.httpmethod),b.get(c.action)||b.set(c.action,c)})}return b}function j(a){var b={};if(a&&a._options&&a._embedded){var c,d;a._options.links.forEach(function(a){"update"===a.rel&&(c=a)});for(var e in a._links)"self"===e&&(d=a._links[e].href);for(var f in a._options.properties)"uri"!==a._options.properties[f].format&&(b[f]={},b[f].metainfo=a._options.properties[f],b[f].value=a[f],b[f].self=d,b[f].required=a._options.required&&a._options.required.indexOf(f)>=0,b[f].editable=c&&c.schema&&f in c.schema.properties,b[f].statusMessages={information:[],warning:[],error:[],errorCount:0},b[f].consistent=!0);for(var g in a._embedded)if(g.indexOf("status_report")>=0&&a._embedded[g].messages){for(var h=0;h<a._embedded[g].messages.length;h++){var i=a._embedded[g].messages[h];i.context in b&&(b[i.context].statusMessages[i.severity].push(i),"information"!==i.severity&&(b[i.context].consistent=!1,b[i.context].statusMessages.errorCount++))}break}}return b}function k(a,b){var c=[];if(a&&a._links)for(var d in a._links)if("item"===d){var e=a._links[d];Array.isArray(e)||(e=[e]);for(var f=0;f<e.length;f++){var g=e[f];if(c.push({href:g.href,title:g.title}),g.summary&&b){b[g.href]=l();for(var h in g.summary)b[g.href].properties[h]={value:g.summary[h]}}}}return c}function l(a,b,c){var d={dependencies:[],properties:{},items:[],deletable:!1,patchable:!1,creatable:!1};return a&&a._links&&a._options&&(a._links.self&&(d.href=a._links.self.href),a._links.up&&(d.up=a._links.up.href),d.properties=j(a),d.dependencies=h(a,b),d.items=k(a,c),a._options.links.forEach(function(a){"update"===a.rel?d.patchable=!0:"delete"===a.rel?d.deletable=!0:"create"===a.rel&&(d.creatable=!0)})),d}var m=this;return this.load=function(c,h,i,j,k){var l;c.regionId=h,l=h?"assets/resources/metamodel/regions/"+h+"/"+i+".json":"assets/resources/metamodel/"+i+".json",a(l).get(function(l){c.screenId=i,b.title=l.metamodel.title,void 0!==b.metamodel&&(b.metamodel[i]=l.metamodel),l.metamodel.colspan=l.metamodel.colspan||12,l.metamodel.offset=l.metamodel.offset||0,l.include&&l.include.length>0?loadReferencedMetaModels(g,c,l,i,j,a,e,b,d,h,k):setScreenData(b,c,l,i,d,j,k),loadOptions(g,c,i,h,b,f)},function(){b.showIcon=!1,g.error(b.appConfig.timeoutMsg)})},this.handleAction=function(a,b,c,d,e,f,h){var i=d.get(c);void 0!==i&&invokeHttpMethod(g,void 0,b,f,e,a,i,h)},this.prepareOptions=function(a,c){if(c){var d=f.refresh,e={},g=d(a,e,b.headers);g.then&&g.then(function(b){console.log("OPTIONS CALL INVOKED URL:"+a);var d=b.data||b;c[a]=i(d)},function(a){throw console.error(a),a})}},this.actionHandling=function(a,c,d,e,f,h,i,j,k){var l=c.metamodel[e]||c.metamodelObject;void 0!==l.defaultValue&&angular.forEach(l.defaultValue,function(a){f===a.action&&("Date"===a.value&&(a.value=formatIntoDate(new Date)),c.data[a.field]=a.value)});var m=l.resourcelist;void 0!==m&&m.length>0&&angular.forEach(m,function(e){var l=d+":"+e;void 0===c.optionsMap&&(c.optionsMap=[]);var n=c.optionsMap[l];if((j||void 0!==i)&&(n=void 0),void 0===n)loadOptionsDataForMetamodel(g,a,m,c,d,b,h,f,i,j,k);else{var o=n.get(f);void 0!==o?httpMethodToBackEnd(g,a,c,h,b,o,k):loadOptionsDataForMetamodel(g,a,m,c,d,b,h,f,i,j,k)}})},this.setHeaders=function(a){a.headers={Accept:"application/vnd.hal+json, application/json","Content-Type":"application/json"},a.user&&a.user.name&&(a.headers.username=a.user.name)},this.getDefaultValues=function(a,b){var c={};return void 0!==b.defaultValue&&angular.forEach(b.defaultValue,function(b){a===b.action&&("Date"===b.value&&(b.value=formatIntoDate(new Date)),c[b.field]={value:b.value})}),c},this.prepareToRender=function(a,b,c,d,g){if(!c)return e(function(a,b){b("No result set to store the results")});c.deferred||(c.deferred=e.defer(),c.pending=1);var h=f.get;g&&(h=f.refresh);var i=JSON.parse(localStorage.getItem(b.resource+"_"+b.actionOnScreen+"_params")),j=h(a,i);return j.then&&j.then(function(e){var f=e.data||e,h={};if(c.pending--,c[a]=l(f,b,h),c[a].identifier=a.substring(a.lastIndexOf("/")+1),c[a].href=a.substring(0,a.lastIndexOf("/")+1)+c[a].identifier,c[a].identifier=d||c[a].identifier,c[a].dependencies.forEach(function(a){c.pending++,m.prepareToRender(a.href,b,c,a.resource)}),b.summary)for(var i in h)c[i]=h[i],c[i].identifier=i.substring(i.lastIndexOf("/")+1),c[i].href=i;else c[a].items.forEach(function(a){c.pending++,m.prepareToRender(a.href,b,c,null,g)});if(0===c.pending){var j=c.deferred;delete c.deferred,delete c.pending,j.resolve(c)}},function(a){throw console.error(a),a}),c.deferred.promise},this}]),app.factory("TableMetaModel",["$resource","$rootScope",function(a,b){return this.load=function(c,d){a("assets/resources/metamodel/table/"+b.regionId+"/"+c+".json").get(function(a){d(a.tableMetaModel)},function(){})},this}]),app.controller("HeaderController",["$scope","$rootScope","$http","$location","$cookieStore","$resource","tmhDynamicLocale",function(a,b,c,d,e,f,g){b.logout=function(){delete b.user,delete localStorage.username,delete c.defaults.headers.common.Authentication,localStorage.clear(),sessionStorage.clear(),e.remove("userid"),b.staticInfo={},d.url("/")},a.setLocate=function(a){b.newlocale=a,angular.forEach(b.localeOpts.options,function(a){a.value===b.newlocale&&(b.selectedLanguage=a.description)}),f("ocInfra/assets/resources/i18n/"+a+".json").get(function(c){b.locale=c,g.set(a)},function(){})},f("assets/resources/metamodel/header.json").get(function(a){b.headermetamodel=a.metamodel},function(){})}]),app.service("LoginSrv",["$rootScope","$resource","$cookieStore","$http","OCRoles","tmhDynamicLocale","growl",function(a,b,c,d,e,f,g){this.runLogin=function(c,h){a.showIcon=!0,d({url:"ocInfra/assets/resources/config/users.json",method:"GET"}).success(function(d){var i=[];if(a.isAuthSuccess=!1,angular.forEach(d.users,function(b){b.name===c.data.inputUsername&&b.password===c.data.inputPassword&&(a.isAuthSuccess=!0,i=b)}),!a.isAuthSuccess)return g.error(a.locale.INVALID_CREDENTIALS),!1;a.user=i,sessionStorage.username=i.name;var j=i.personalizationData.locale;a.newlocale=j,b("ocInfra/assets/resources/i18n/"+a.newlocale+".json").get(function(b){a.locale=b,f.set(a.newlocale),e.load(i.roles[0],h)},function(){})}).error(function(b){a.showIcon=!1,b&&b.exception?g.error(b.exception.message,"30"):g.error(a.locale.GENERAL_ERROR)})}}]),app.service("OCRoles",["$resource","$rootScope","$location",function(a,b,c){return this.load=function(d,e){a("ocInfra/assets/resources/config/roles.json").get(function(a){angular.forEach(a.Roles,function(a){void 0!==a[d]&&(b.roleConfig=a[d])}),void 0!==e&&c.path(e)})},this}]),app.factory("resourceFactory",["$http","$rootScope","$q",function(a,b,c){function d(a){if(void 0===a&&(a={}),b.config.apiGatewayApiKeys)for(var c in b.config.apiGatewayApiKeys)a[c]=b.config.apiGatewayApiKeys[c];return a}function e(e,f,g){f&&Object.keys(f).length>0&&(k[e]=null),f=d(f);var h;return k[e]?(h=c(function(a){k[e]===l?b.$on("resource_directory",function(b,c){c.url===e&&a(k[e])}):a(k[e])}),h.success=function(a){var b=a;return h.then(b,null),h},h.error=function(a){var b=a;return h.then(null,b),h}):(k[e]=l,h=a({method:"GET",url:e,params:f,headers:g}),h.then&&h.then(function(a){var c=k[e];k[e]=a,b.$broadcast("resource_directory",{url:e,response:a,previous:c})},function(a){throw console.error(a),a})),h}function f(a,b,c){return k[a]=null,e(a,b,c)}function g(c,e,f){var g=d({}),h=a({method:"POST",url:c,headers:f,params:g,data:e});return h.then&&h.then(function(a){k[a.data._links.self.href]=a,b.$broadcast("resource_directory",{url:c,response:a,previous:void 0})},function(a){return a}),h}function h(c,e){var f=d({}),g=a({method:"DELETE",url:c,headers:e,params:f});return g.then&&g.then(function(a){var d=k[c];k[c]=null,b.$broadcast("resource_directory",{url:c,response:a,previous:d})},function(a){throw console.error(a),a}),g}function i(c,e,f){var g=d({}),h=a({method:"PATCH",url:c,headers:f,params:g,data:e});return h.then&&h.then(function(a){var d=k[c];k[c]=a,b.$broadcast("resource_directory",{url:c,response:a,previous:d})},function(a){throw console.error(a),a}),h}function j(c,d,e,f,g){var h=a({method:g,url:c,headers:f,data:d,params:e});return h.then&&h.then(function(a){k[a.data._links.self.href]=a,b.$broadcast("resource_directory",{url:c,response:a})},function(a){throw console.error(a),a}),h}var k={},l="0";return{get:e,refresh:f,post:g,"delete":h,patch:i,execute:j,getData:function(b){return a.get(b)},insert:function(b,c){return a.post(b,c)},update:function(b,c){return a.put(b+"/"+c.id,c)},options:function(b,c){var e=d({}),f=a({method:"GET",url:b,headers:c,params:e});return f}}}]);var screenname;app.service("OCInfraConfig",["$resource","$rootScope",function(a,b){this.load=function(){b.infraConfig={},a("vendors/OcInfra/client-infrastructure/dist/ocInfra/assets/resources/config/OCInfraConfig.json").get(function(a){b.infraConfig=a.config.base,b.metamodelPath=a.config.base.templates.metaModel,angular.forEach(b.infraConfig.properties,function(a){"language"===a.name&&(b.localeOpts=angular.fromJson('{"options":'+angular.toJson(a.options)+"}"),angular.forEach(b.localeOpts.options,function(a){a.description=a.description}))})})}}]),app.service("FieldService",function(){this.checkVisibility=function(a,b){return!a.visibleWhen||(b.data[a.visibleWhen.expression.field]===a.visibleWhen.expression.value||void 0)}}),app.service("OCMetadata",["$rootScope","$resource",function(a,b){this.load=function(c,d){var e=a.screenId,f=d+e+".json";a.metamodel={},c.data={},b(f).get(function(b){a.metamodel[e]=b.metamodel,a.title=b.metamodel.title,c.screenId=e})}}]),app.service("OCRoles",["$resource","$rootScope","$location",function(a,b,c){return this.load=function(d,e){a("ocInfra/assets/resources/config/roles.json").get(function(a){angular.forEach(a.Roles,function(a){void 0!==a[d]&&(b.roleConfig=a[d])}),void 0!==e&&c.path(e)})},this}]),app.service("EnumerationService",["$rootScope","resourceFactory",function(a,b){var c=this;c.loadEnumerationByTab=function(){if(a.resourceHref&&a.currRel)if("itself"===a.currRel){var d=a.resourceHref;b.options(d,a.headers).success(function(a){var b=a.data||a;c.executeEnumerationFromBackEnd(b,"update")})}else b.options(a.resourceHref,a.headers).success(function(d){var e=d.data||d;if(void 0!==e._links[a.currRel]){var f=e._links[a.currRel].href;b.options(f,a.headers).success(function(d){var e=d.data||d,f=e._links.item.href;b.options(f,a.headers).success(function(a){var b=a.data||a;c.executeEnumerationFromBackEnd(b,"update")})})}});else void 0!==a.resourceHref&&b.options(a.resourceHref,a.headers).success(function(a){var b=a.data||a;c.executeEnumerationFromBackEnd(b,"search")})},c.executeEnumerationFromBackEnd=function(b,c){angular.forEach(b._options.links,function(b){b.rel===c&&angular.forEach(b.schema.properties,function(b,c){b["enum"]&&d(a,b["enum"],c)})})};var d=function(a,b,c){var d={},f=null;b?(d[c]=e(b),angular.extend(a.enumData,d)):d[c]=a.enumData[c],d[f]=d[c],angular.extend(a.enumData,d)},e=function(a){var b=[];return angular.forEach(a,function(a){b.push(a)}),b};return c}]),app.service("CheckVisibleService",function(){function a(b,c){var d=!0;return b.operator?"AND"===b.operator?angular.forEach(b.conditions,function(b){d&&(d=d&&a(b,c))}):"OR"===b.operator&&(d=!1,angular.forEach(b.conditions,function(b){d||(d=d||a(b,c))})):d=c.data[b.field]===b.value,d}return this.checkVisible=function(b,c){if(b.visibleWhen){var d=a(b.visibleWhen.expression,c);return d}return!0},this}),app.controller("TableController",["$browser","$scope","$rootScope","TableMetaModel","MetaModel","resourceFactory","$location","CheckVisibleService",function(a,b,c,d,e,f,g,h){b.showResult=!0,b.riskDataSet=[],c.rowCollection={},b.loadTableMetadata=function(){d.load(b.field.name,function(a){b.field.tableMetaData=a})},b.checkShow=function(a){return a.visibleWhen?h.checkVisible(a,b):void 0===a.visibleflag||(void 0===c.config[a.visibleflag]||c.config[a.visibleflag]===!0)},b.doActionItem=function(a,d,g,h){var i=c.screenId,j=c.regionId;c.resourceHref=d.href;var k=!0;void 0!==h?c.navigate(h):e.actionHandling(d,b,j,i,a,f,void 0,k)},b.loadTableMetadata(),b.editItem=function(a,b){c.resourceHref=a._link.self.href,c.navigate(b)},b.selectItem=function(a,b){c.resourceHref=a._link.self.href,c.navigate(b)},c.navigate=function(a){g.path(a)}}]);